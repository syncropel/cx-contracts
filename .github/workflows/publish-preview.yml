name: "Ring 1: Publish Preview"

# ====================================================================
#  TRIGGERS: When this workflow will run
# ====================================================================
on:
  push:
    branches:
      - main
  workflow_dispatch: {}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ====================================================================
  #  JOB 1: Build and publish the preview package
  # ====================================================================
  publish:
    name: "1. Publish Preview Packages"
    runs-on: ubuntu-latest
    outputs:
      preview_version: ${{ steps.version.outputs.preview_version }}

    steps:
      - name: "Checkout Code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Setup PNPM & Node.js"
        uses: pnpm/action-setup@v3
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          registry-url: "https://registry.npmjs.org"

      - name: "Install & Build"
        run: |
          pnpm install
          pnpm build

      - name: "Generate and Set Preview Version"
        id: version
        run: |
          VERSION_BASE=$(jq -r .version packages/core/package.json)
          SHORT_SHA=$(git rev-parse --short HEAD)
          PREVIEW_VERSION="${VERSION_BASE}-preview.${SHORT_SHA}"
          echo "preview_version=${PREVIEW_VERSION}" >> $GITHUB_OUTPUT
          echo "Generated Preview Version: ${PREVIEW_VERSION}"

          # Use pnpm exec to set the version for the specific package
          pnpm --filter @syncropel/cx-contracts exec pnpm version ${PREVIEW_VERSION} --no-git-tag-version

      - name: "Publish to NPM"
        run: |
          pnpm --filter @syncropel/cx-contracts publish --tag preview --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # ====================================================================
  #  JOB 2: Trigger downstream tests in parallel
  # ====================================================================
  trigger:
    name: "2. Trigger Downstream Tests (${{ matrix.repo }})"
    runs-on: ubuntu-latest
    needs: publish
    permissions:
      actions: write

    strategy:
      matrix:
        repo: ["syncropel-ui", "cx-shell"]
      fail-fast: false

    steps:
      - name: "Trigger test workflow in ${{ matrix.repo }}"
        run: |
          echo "Triggering test run in ${{ matrix.repo }} for version ${{ needs.publish.outputs.preview_version }}"
          gh workflow run test-with-preview.yml \
            --repo syncropel/${{ matrix.repo }} \
            --ref main \
            -f contract_version='${{ needs.publish.outputs.preview_version }}'
        env:
          GH_TOKEN: ${{ secrets.DOWNSTREAM_TRIGGER_TOKEN }}

  # ====================================================================
  #  JOB 3: Evaluate the results of the downstream tests
  # ====================================================================
  evaluate:
    name: "3. Evaluate Downstream Results"
    runs-on: ubuntu-latest
    if: always() # This job should run even if the trigger jobs fail
    needs: [publish, trigger]

    steps:
      - name: "Evaluate workflow status"
        run: |
          if [[ "${{ needs.trigger.result }}" == "success" ]]; then
            echo "✅ All downstream tests were triggered successfully."
            # In a real scenario, you'd have a script here to poll for the results of those runs.
            echo "Proceeding to notify for Canary promotion."
          else
            echo "❌ Failed to trigger one or more downstream tests."
            # You would post a failure to Slack here.
            exit 1
          fi
