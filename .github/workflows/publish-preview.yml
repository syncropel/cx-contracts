name: "Ring 1: Publish Preview"

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ====================================================================
  # JOB 1: Build and publish the preview package
  # ====================================================================
  publish:
    name: "1. Publish Preview Packages"
    runs-on: ubuntu-latest
    outputs:
      preview_version: ${{ steps.version.outputs.preview_version }}

    steps:
      - name: "Checkout Code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Setup PNPM & Node.js"
        uses: pnpm/action-setup@v3
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          registry-url: "https://registry.npmjs.org"

      - name: "Install & Build"
        run: |
          pnpm install
          pnpm build

      - name: "Generate Preview Version"
        id: version
        run: |
          VERSION_BASE=$(jq -r .version packages/core/package.json)
          SHORT_SHA=$(git rev-parse --short HEAD)
          PREVIEW_VERSION="${VERSION_BASE}-preview.${SHORT_SHA}"
          echo "preview_version=${PREVIEW_VERSION}" >> $GITHUB_ENV
          echo "preview_version=${PREVIEW_VERSION}" >> $GITHUB_OUTPUT # Make available to other jobs
          echo "Publishing Preview Version: ${PREVIEW_VERSION}"

      - name: "Publish to NPM"
        run: |
          pnpm --filter @syncropel/cx-contracts version ${{ env.PREVIEW_VERSION }}
          pnpm --filter @syncropel/cx-contracts publish --tag preview --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      # ... (Add steps here to publish to PyPI if needed) ...

  # ====================================================================
  # JOB 2: Trigger downstream tests in parallel using a matrix strategy
  # ====================================================================
  trigger:
    name: "2. Trigger Downstream Tests (${{ matrix.repo }})"
    runs-on: ubuntu-latest
    needs: publish # This job depends on the 'publish' job completing successfully
    permissions:
      actions: write

    strategy: # <--- CORRECT PLACEMENT of the strategy block
      matrix:
        repo: ["syncropel-ui", "cx-shell", "studio-enterprise"]
      fail-fast: false # Don't cancel other matrix jobs if one fails

    steps:
      - name: "Trigger test workflow in ${{ matrix.repo }}"
        run: |
          echo "Triggering test run in ${{ matrix.repo }} for version ${{ needs.publish.outputs.preview_version }}"
          gh workflow run test-with-preview.yml \
            --repo syncropel/${{ matrix.repo }} \
            --ref main \
            -f contract_version='${{ needs.publish.outputs.preview_version }}'
        env:
          GH_TOKEN: ${{ secrets.DOWNSTREAM_TRIGGER_TOKEN }}

  # ====================================================================
  # JOB 3: Wait for and evaluate the results of the downstream tests
  # ====================================================================
  evaluate:
    name: "3. Evaluate Downstream Results"
    runs-on: ubuntu-latest
    needs: trigger # This job runs after all matrix jobs in 'trigger' are complete

    steps:
      - name: "Wait for downstream workflows to complete"
        # In a real implementation, this step would use the GitHub API to poll
        # for the completion of the dispatched workflows. This is a complex script.
        # For now, we simulate success to keep the pipeline moving.
        run: |
          echo "Simulating wait and evaluation..."
          echo "In a production environment, this job would poll the status of the runs triggered in the previous job."
          echo "Assuming all downstream tests passed for now."

      - name: "Notify Success / Failure"
        # This step would check the results from the previous step and decide
        # whether to proceed to Ring 2 (Canary).
        run: echo "Evaluation complete. Ready to promote to Canary."
