jobs:
  # ====================================================================
  # JOB 1: Build and publish the preview package
  # ====================================================================
  publish:
    name: "1. Publish Preview Packages"
    runs-on: ubuntu-latest
    outputs:
      preview_version: ${{ steps.version.outputs.preview_version }}

    steps:
      - name: "Checkout Code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Setup PNPM & Node.js"
        uses: pnpm/action-setup@v3
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          registry-url: "https://registry.npmjs.org"

      - name: "Install & Build"
        run: |
          pnpm install
          pnpm build

      - name: "Generate and Set Preview Version"
        id: version
        run: |
          # Get base version from the core package's package.json
          VERSION_BASE=$(jq -r .version packages/core/package.json)
          SHORT_SHA=$(git rev-parse --short HEAD)
          PREVIEW_VERSION="${VERSION_BASE}-preview.${SHORT_SHA}"

          echo "PREVIEW_VERSION=${PREVIEW_VERSION}" >> $GITHUB_ENV
          echo "preview_version=${PREVIEW_VERSION}" >> $GITHUB_OUTPUT
          echo "Generated Preview Version: ${PREVIEW_VERSION}"

          # CRITICAL FIX: Use pnpm to set the version for the specific package
          pnpm --filter @syncropel/cx-contracts exec pnpm version ${PREVIEW_VERSION} --no-git-tag-version

      - name: "Publish to NPM"
        run: |
          # The package.json now has the correct preview version, so we can just publish.
          pnpm --filter @syncropel/cx-contracts publish --tag preview --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
